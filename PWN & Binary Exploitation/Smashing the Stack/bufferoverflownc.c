#include <stdio.h>                                                                                                                         
#include <stdlib.h>                                                                                                                        
#include <string.h>                                                                                                                        
#include <signal.h>                                                                                                                        
                                                                                                                                           
#define FLAGSIZE_MAX 128                                                                                                                   
                                                                                                                                           
char flag[FLAGSIZE_MAX];                                                                                                                   
                                                                                                                                           
void sigsegv_handler(int sig) 
{                                                                                                            
  fprintf(stderr, "Buffer Overflowed! Here's your flag: %s\n", flag);                                                                           
  fflush(stderr);                                                                                                                          
  exit(1);                                                                                                                                 
}                                                                                                                                          
                                                                                                                                           
void setup()
{                                                                                                                              
  FILE *f = fopen("flag.txt","r");                                                                                                         
  fgets(flag,FLAGSIZE_MAX,f);                                                                                                              
  signal(SIGSEGV, sigsegv_handler);                                                                                                        
  gid_t gid = getegid();                                                                                                                   
  setresgid(gid, gid, gid);                                                                                                                
}                                                                                                                                          

int upkeep()
{
  setvbuf(stdin, NULL, _IONBF, 0);
  setvbuf(stdout, NULL, _IONBF, 0);
  setvbuf(stderr, NULL, _IONBF, 0);
}                                                                                                                              
                                                                                                                                           
int main(int argc, char **argv)
{                                                                                                           
  upkeep();
  setup();                                                                                                                                 
  char message[8];                                                                                                                                                                                                                                                                                              
  printf("Leave a message: ");                                                                                                             
  gets(message);                                                                                                                              
  printf("Your message was saved successfully: %s\n",message);                                                                                                            
  return 0;                                                                                                                                
}